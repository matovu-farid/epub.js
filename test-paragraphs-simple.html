<!DOCTYPE html>
<html>
  <head>
    <title>Simple Paragraph Test</title>
  </head>
  <body>
    <h1>Test: getCurrentViewParagraphs() vs getCurrentViewText()</h1>
    <div
      id="viewer"
      style="width: 600px; height: 400px; border: 1px solid #ccc"
    ></div>
    <div id="results"></div>

    <script src="src/epub.js"></script>
    <script>
      var book = ePub("test/fixtures/alice.epub");
      var rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
        flow: "paginated",
      });

      rendition.display().then(function () {
        // Wait a bit for rendering
        setTimeout(function () {
          testComparison();
        }, 1000);
      });

      function testComparison() {
        var textResult = rendition.getCurrentViewText();
        var paragraphsResult = rendition.getCurrentViewParagraphs();

        console.log("Text result:", textResult);
        console.log("Paragraphs result:", paragraphsResult);

        if (!textResult || !paragraphsResult) {
          document.getElementById("results").innerHTML =
            "<p>Error: One or both methods returned null</p>";
          return;
        }

        var fullText = textResult.text;
        var paragraphs = paragraphsResult;

        // Combine all paragraph texts
        var combinedParagraphsText = paragraphs
          .map(function (p) {
            return p.text;
          })
          .join("");

        // Normalize whitespace for comparison
        var normalizedFullText = fullText.replace(/\s+/g, " ").trim();
        var normalizedCombinedText = combinedParagraphsText
          .replace(/\s+/g, " ")
          .trim();

        // Check if they match
        var matches = normalizedFullText === normalizedCombinedText;

        var result =
          "<h3>Test Result: " +
          (matches ? "✅ MATCH" : "❌ MISMATCH") +
          "</h3>";
        result +=
          "<p><strong>Full text length:</strong> " +
          fullText.length +
          " characters</p>";
        result +=
          "<p><strong>Combined paragraphs length:</strong> " +
          combinedParagraphsText.length +
          " characters</p>";
        result +=
          "<p><strong>Number of paragraphs:</strong> " +
          paragraphs.length +
          "</p>";

        if (!matches) {
          result +=
            "<p><strong>Difference:</strong> " +
            (fullText.length - combinedParagraphsText.length) +
            " characters</p>";
          result +=
            "<p><strong>Full text (first 200):</strong> " +
            fullText.substring(0, 200) +
            "</p>";
          result +=
            "<p><strong>Combined (first 200):</strong> " +
            combinedParagraphsText.substring(0, 200) +
            "</p>";
        }

        result += "<h4>Individual Paragraphs:</h4>";
        paragraphs.forEach(function (paragraph, index) {
          result +=
            "<p><strong>Paragraph " +
            (index + 1) +
            ":</strong> " +
            paragraph.text.substring(0, 100) +
            (paragraph.text.length > 100 ? "..." : "") +
            "</p>";
        });

        document.getElementById("results").innerHTML = result;
      }
    </script>
  </body>
</html>
