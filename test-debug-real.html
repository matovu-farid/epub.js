<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Real Implementation - getCurrentViewParagraphs()</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .controls {
        text-align: center;
        margin-bottom: 20px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 0 10px;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        border-left: 4px solid #28a745;
        background: #d4edda;
      }
      .error {
        border-left: 4px solid #dc3545;
        background: #f8d7da;
      }
      .info {
        border-left: 4px solid #17a2b8;
        background: #d1ecf1;
      }
      .test-section {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
      }
      .test-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }
      #viewer {
        width: 100%;
        height: 400px;
        border: 1px solid #ddd;
        margin: 20px 0;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Debug Real Implementation - getCurrentViewParagraphs()</h1>
      <p>
        This test will help debug why the method returns nothing in your real
        project.
      </p>

      <div class="controls">
        <button id="debugBtn">üîç Debug Method Step by Step</button>
        <button id="testBtn">üß™ Test with Mock EPUB</button>
      </div>

      <div id="viewer">No EPUB loaded - debugging mode</div>

      <div class="test-section">
        <div class="test-title">üîç Debug Output</div>
        <div id="debugOutput" class="result"></div>
      </div>
    </div>

    <script src="dist/epub.min.js"></script>
    <script>
      const debugBtn = document.getElementById("debugBtn");
      const testBtn = document.getElementById("testBtn");
      const debugOutput = document.getElementById("debugOutput");

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}`;
        console.log(logMessage);
        debugOutput.textContent += logMessage + "\n";
        debugOutput.scrollTop = debugOutput.scrollHeight;
      }

      function clearOutput() {
        debugOutput.textContent = "";
      }

      function debugMethodStepByStep() {
        clearOutput();
        log("üîç Debugging getCurrentViewParagraphs() step by step...");

        try {
          // Check if epub.js is loaded
          log("üîç Step 1: Checking if epub.js is loaded...");
          if (typeof ePub === "undefined") {
            log("‚ùå ePub constructor not found - epub.js not loaded");
            return;
          }
          log("‚úÖ ePub constructor found");

          // Create a mock book
          log("üîç Step 2: Creating mock book and rendition...");

          // Create a simple mock rendition that mimics the real structure
          const mockRendition = {
            manager: null,

            // Override the actual method to add debugging
            getCurrentViewParagraphs() {
              log("üìû getCurrentViewParagraphs() called");

              log("üîç Checking manager...");
              if (!this.manager) {
                log("‚ùå No manager - returning null");
                return null;
              }
              log("‚úÖ Manager exists");

              log("üîç Getting current location...");
              const location = this.manager.currentLocation();
              log(`üìä Location result: ${JSON.stringify(location)}`);

              if (!location || !location.length || !location[0]) {
                log("‚ùå No location data - returning null");
                return null;
              }
              log("‚úÖ Location data exists");

              const visibleSection = location[0];
              log(`üìä Visible section: ${JSON.stringify(visibleSection)}`);

              if (
                !visibleSection.mapping ||
                !visibleSection.mapping.start ||
                !visibleSection.mapping.end
              ) {
                log("‚ùå No mapping data - returning null");
                return null;
              }
              log("‚úÖ Mapping data exists");

              log("üîç Finding view...");
              const view = this.manager.views.find({
                index: visibleSection.index,
              });
              if (!view || !view.contents || !view.contents.document) {
                log("‚ùå No view or contents - returning null");
                return null;
              }
              log("‚úÖ View and contents exist");

              log("üîç Creating CFI ranges...");
              try {
                const startCfi = new EpubCFI(visibleSection.mapping.start);
                const endCfi = new EpubCFI(visibleSection.mapping.end);
                log("‚úÖ CFI objects created");

                const startRange = startCfi.toRange(view.contents.document);
                const endRange = endCfi.toRange(view.contents.document);

                if (!startRange || !endRange) {
                  log("‚ùå Could not create DOM ranges from CFIs");
                  return null;
                }
                log("‚úÖ DOM ranges created");

                const range = view.contents.document.createRange();
                range.setStart(
                  startRange.startContainer,
                  startRange.startOffset
                );
                range.setEnd(endRange.endContainer, endRange.endOffset);
                log("‚úÖ Combined range created");

                log("üîç Extracting paragraphs...");
                const paragraphs = this._getParagraphsFromRange(
                  range,
                  view.contents
                );
                log(
                  `üìä Extracted ${
                    paragraphs ? paragraphs.length : 0
                  } paragraphs`
                );

                return paragraphs;
              } catch (e) {
                log(`‚ùå Error in CFI/range processing: ${e.message}`);
                return null;
              }
            },

            // Mock the helper method
            _getParagraphsFromRange(range, contents) {
              log("üìû _getParagraphsFromRange() called");

              try {
                const fullText = range.toString();
                log(`üìù Range text: "${fullText}"`);

                if (!fullText.trim()) {
                  log("‚ùå Range has no text");
                  return [];
                }

                // Simple mock implementation for debugging
                const mockParagraphs = [
                  {
                    text: "Debug paragraph 1",
                    cfi: "epubcfi(/6/4[p]!/4/2/1:0)",
                  },
                  {
                    text: "Debug paragraph 2",
                    cfi: "epubcfi(/6/4[div]!/4/2/1:0)",
                  },
                ];

                log(`‚úÖ Returning ${mockParagraphs.length} mock paragraphs`);
                return mockParagraphs;
              } catch (e) {
                log(`‚ùå Error in _getParagraphsFromRange: ${e.message}`);
                return [];
              }
            },
          };

          log("üîç Step 3: Testing with no manager...");
          const resultNoManager = mockRendition.getCurrentViewParagraphs();
          log(`üìä Result with no manager: ${resultNoManager}`);

          log("üîç Step 4: Testing with mock manager...");
          mockRendition.manager = {
            currentLocation() {
              log("üìû manager.currentLocation() called");
              return [
                {
                  index: 0,
                  mapping: {
                    start: "epubcfi(/6/4[p]!/4/2/1:0)",
                    end: "epubcfi(/6/4[p]!/4/2/1:100)",
                  },
                },
              ];
            },
            views: {
              find({ index }) {
                log(`üìû views.find() called with index: ${index}`);
                return {
                  contents: {
                    document: {
                      createRange() {
                        log("üìû document.createRange() called");
                        return {
                          setStart: () => log("üìû range.setStart() called"),
                          setEnd: () => log("üìû range.setEnd() called"),
                          toString: () => {
                            log("üìû range.toString() called");
                            return "Mock range text content";
                          },
                        };
                      },
                    },
                    cfiFromNode(element) {
                      log("üìû contents.cfiFromNode() called");
                      return {
                        toString() {
                          return "epubcfi(/6/4[p]!/4/2/1:0)";
                        },
                      };
                    },
                  },
                };
              },
            },
          };

          const resultWithManager = mockRendition.getCurrentViewParagraphs();
          log(`üìä Final result: ${JSON.stringify(resultWithManager)}`);

          if (resultWithManager && resultWithManager.length > 0) {
            log("üéâ SUCCESS: Method works with proper manager setup!");
          } else {
            log(
              "‚ùå FAILURE: Method still returns nothing even with mock manager"
            );
          }
        } catch (error) {
          log(`üí• Debug failed: ${error.message}`);
          log(`Stack trace: ${error.stack}`);
        }
      }

      function testWithMockEpub() {
        clearOutput();
        log("üß™ Testing with mock EPUB structure...");

        try {
          // Create a more realistic mock
          const mockBook = {
            title: "Mock Book",
            spine: { length: 1 },
          };

          const mockRendition = {
            manager: {
              currentLocation() {
                return [
                  {
                    index: 0,
                    mapping: {
                      start: "epubcfi(/6/4[p]!/4/2/1:0)",
                      end: "epubcfi(/6/4[p]!/4/2/1:100)",
                    },
                  },
                ];
              },
              views: {
                find({ index }) {
                  return {
                    contents: {
                      document: document, // Use real document
                      cfiFromNode(element) {
                        return {
                          toString() {
                            return `epubcfi(/6/4[${element.tagName}]!/4/2/1:0)`;
                          },
                        };
                      },
                    },
                  };
                },
              },
            },
          };

          // Test the actual epub.js methods if they exist
          if (typeof ePub !== "undefined") {
            log("üîç Testing with real epub.js methods...");

            // Try to create a real rendition
            const testEpub = new ePub();

            // Add our method to the prototype for testing
            if (!testEpub.renderTo) {
              testEpub.renderTo = function () {
                return mockRendition;
              };
            }

            log("‚úÖ Mock epub setup complete");
          }
        } catch (error) {
          log(`üí• Mock EPUB test failed: ${error.message}`);
        }
      }

      debugBtn.addEventListener("click", debugMethodStepByStep);
      testBtn.addEventListener("click", testWithMockEpub);

      // Initialize
      log("üöÄ Debug page loaded and ready");
      log("üí° Click 'Debug Method Step by Step' to see where the method fails");
    </script>
  </body>
</html>
