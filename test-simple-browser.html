<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Browser Test - Check EpubCFI</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        border-left: 4px solid #28a745;
        background: #d4edda;
      }
      .error {
        border-left: 4px solid #dc3545;
        background: #f8d7da;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Simple Browser Test - Check EpubCFI Availability</h1>
      <p>
        This test checks if EpubCFI is available in the browser environment.
      </p>

      <div id="output" class="result"></div>
    </div>

    <script src="dist/epub.min.js"></script>
    <script>
      const output = document.getElementById("output");

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}`;
        console.log(logMessage);
        output.textContent += logMessage + "\n";
        output.scrollTop = output.scrollHeight;
      }

      function runTest() {
        log("üîç Testing EpubCFI availability...");

        try {
          // Test 1: Check if ePub constructor exists
          log("üîç Test 1: Checking ePub constructor...");
          if (typeof ePub === "undefined") {
            log("‚ùå ePub constructor not found");
            return;
          }
          log("‚úÖ ePub constructor found");

          // Test 2: Check if EpubCFI is available globally
          log("üîç Test 2: Checking EpubCFI globally...");
          if (typeof EpubCFI === "undefined") {
            log("‚ùå EpubCFI not available globally");
          } else {
            log("‚úÖ EpubCFI available globally");
          }

          // Test 3: Try to create a book and check internal structure
          log("üîç Test 3: Creating mock book...");
          const book = new ePub();
          log("‚úÖ Mock book created");

          // Test 4: Check if we can access EpubCFI through the book
          log("üîç Test 4: Checking EpubCFI through book...");
          if (book.epubcfi && typeof book.epubcfi.constructor === "function") {
            log("‚úÖ EpubCFI accessible through book.epubcfi");
            log(`üìä EpubCFI constructor: ${book.epubcfi.constructor.name}`);
          } else {
            log("‚ùå EpubCFI not accessible through book.epubcfi");
          }

          // Test 5: Try to create a rendition and check methods
          log("üîç Test 5: Creating mock rendition...");

          // Create a mock rendition with our method
          const mockRendition = {
            manager: {
              currentLocation() {
                return [
                  {
                    index: 0,
                    mapping: {
                      start: "epubcfi(/6/4[p]!/4/2/1:0)",
                      end: "epubcfi(/6/4[p]!/4/2/1:100)",
                    },
                  },
                ];
              },
              views: {
                find({ index }) {
                  return {
                    contents: {
                      document: document,
                      cfiFromNode(element) {
                        return {
                          toString() {
                            return "epubcfi(/6/4[p]!/4/2/1:0)";
                          },
                        };
                      },
                    },
                  };
                },
              },
            },

            getCurrentViewText() {
              log("üìû getCurrentViewText() called");
              try {
                const location = this.manager.currentLocation();
                if (!location || !location.length || !location[0]) {
                  return null;
                }

                const visibleSection = location[0];
                if (
                  !visibleSection.mapping ||
                  !visibleSection.mapping.start ||
                  !visibleSection.mapping.end
                ) {
                  return null;
                }

                const view = this.manager.views.find({
                  index: visibleSection.index,
                });
                if (!view || !view.contents || !view.contents.document) {
                  return null;
                }

                log("üîç Creating CFI ranges in getCurrentViewText...");
                const startCfi = new EpubCFI(visibleSection.mapping.start);
                const endCfi = new EpubCFI(visibleSection.mapping.end);
                log("‚úÖ CFI objects created in getCurrentViewText");

                return {
                  text: "Mock text content",
                  startCfi: visibleSection.mapping.start,
                  endCfi: visibleSection.mapping.end,
                };
              } catch (e) {
                log(`‚ùå Error in getCurrentViewText: ${e.message}`);
                return null;
              }
            },

            getCurrentViewParagraphs() {
              log("üìû getCurrentViewParagraphs() called");
              try {
                const location = this.manager.currentLocation();
                if (!location || !location.length || !location[0]) {
                  return null;
                }

                const visibleSection = location[0];
                if (
                  !visibleSection.mapping ||
                  !visibleSection.mapping.start ||
                  !visibleSection.mapping.end
                ) {
                  return null;
                }

                const view = this.manager.views.find({
                  index: visibleSection.index,
                });
                if (!view || !view.contents || !view.contents.document) {
                  return null;
                }

                log("üîç Creating CFI ranges in getCurrentViewParagraphs...");
                const startCfi = new EpubCFI(visibleSection.mapping.start);
                const endCfi = new EpubCFI(visibleSection.mapping.end);
                log("‚úÖ CFI objects created in getCurrentViewParagraphs");

                return [
                  {
                    text: "Mock paragraph 1",
                    cfi: "epubcfi(/6/4[p]!/4/2/1:0)",
                  },
                  {
                    text: "Mock paragraph 2",
                    cfi: "epubcfi(/6/4[div]!/4/2/1:0)",
                  },
                ];
              } catch (e) {
                log(`‚ùå Error in getCurrentViewParagraphs: ${e.message}`);
                return null;
              }
            },
          };

          log("‚úÖ Mock rendition created");

          // Test 6: Test getCurrentViewText
          log("üîç Test 6: Testing getCurrentViewText...");
          const textResult = mockRendition.getCurrentViewText();
          log(
            `üìä getCurrentViewText result: ${textResult ? "SUCCESS" : "NULL"}`
          );

          // Test 7: Test getCurrentViewParagraphs
          log("üîç Test 7: Testing getCurrentViewParagraphs...");
          const paragraphsResult = mockRendition.getCurrentViewParagraphs();
          log(
            `üìä getCurrentViewParagraphs result: ${
              paragraphsResult ? "SUCCESS" : "NULL"
            }`
          );

          if (textResult && paragraphsResult) {
            log("üéâ SUCCESS: Both methods work!");
          } else {
            log("‚ùå FAILURE: One or both methods failed");
          }
        } catch (error) {
          log(`üí• Test failed: ${error.message}`);
          log(`Stack trace: ${error.stack}`);
        }
      }

      // Run the test when page loads
      runTest();
    </script>
  </body>
</html>
