<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Paragraphs vs Text</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .viewer {
        flex: 1;
        border: 1px solid #ccc;
        height: 600px;
      }
      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        padding: 10px 20px;
        background: #007cba;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #005a87;
      }
      .results {
        flex: 1;
        padding: 20px;
        background: #f5f5f5;
      }
      .result-section {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border: 1px solid #ddd;
      }
      .result-section h3 {
        margin-top: 0;
        color: #333;
      }
      .text-content {
        white-space: pre-wrap;
        font-family: monospace;
        background: #f9f9f9;
        padding: 10px;
        border: 1px solid #eee;
        max-height: 200px;
        overflow-y: auto;
      }
      .paragraph-item {
        margin-bottom: 10px;
        padding: 8px;
        background: #f0f8ff;
        border-left: 3px solid #007cba;
      }
      .paragraph-text {
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
      }
      .paragraph-cfi {
        font-size: 10px;
        color: #666;
        margin-top: 5px;
      }
      .comparison {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 10px;
        margin: 10px 0;
      }
      .match {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .mismatch {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>Test: getCurrentViewParagraphs() vs getCurrentViewText()</h1>
    <p>
      This test compares the combined text from paragraphs against the full text
      from getCurrentViewText() to ensure they match.
    </p>

    <div class="controls">
      <button id="prev">Previous</button>
      <button id="next">Next</button>
      <button id="test-comparison">Test Comparison</button>
      <button id="clear-results">Clear Results</button>
    </div>

    <div class="container">
      <div id="viewer" class="viewer"></div>

      <div class="results">
        <div id="test-results">
          <p>Click "Test Comparison" to compare paragraphs vs full text.</p>
        </div>
      </div>
    </div>

    <script src="../src/epub.js"></script>
    <script>
      var book = ePub("../test/fixtures/alice.epub");
      var rendition = book.renderTo("viewer", {
        width: "100%",
        height: "100%",
        flow: "paginated",
      });

      // Navigation
      document.getElementById("prev").addEventListener("click", function () {
        rendition.prev();
      });

      document.getElementById("next").addEventListener("click", function () {
        rendition.next();
      });

      document
        .getElementById("clear-results")
        .addEventListener("click", function () {
          document.getElementById("test-results").innerHTML =
            "<p>Results cleared. Click 'Test Comparison' to run a new test.</p>";
        });

      // Test comparison
      document
        .getElementById("test-comparison")
        .addEventListener("click", function () {
          runComparisonTest();
        });

      function runComparisonTest() {
        var resultsDiv = document.getElementById("test-results");

        // Get both text and paragraphs
        var textResult = rendition.getCurrentViewText();
        var paragraphsResult = rendition.getCurrentViewParagraphs();

        if (!textResult) {
          resultsDiv.innerHTML =
            '<div class="mismatch"><h3>Error</h3><p>getCurrentViewText() returned null</p></div>';
          return;
        }

        if (!paragraphsResult) {
          resultsDiv.innerHTML =
            '<div class="mismatch"><h3>Error</h3><p>getCurrentViewParagraphs() returned null</p></div>';
          return;
        }

        var fullText = textResult.text;
        var paragraphs = paragraphsResult;

        // Combine all paragraph texts
        var combinedParagraphsText = paragraphs
          .map(function (p) {
            return p.text;
          })
          .join("");

        // Normalize whitespace for comparison
        var normalizedFullText = fullText.replace(/\s+/g, " ").trim();
        var normalizedCombinedText = combinedParagraphsText
          .replace(/\s+/g, " ")
          .trim();

        // Check if they match
        var matches = normalizedFullText === normalizedCombinedText;

        // Display results
        var html = '<div class="' + (matches ? "match" : "mismatch") + '">';
        html +=
          "<h3>Comparison Result: " +
          (matches ? "✅ MATCH" : "❌ MISMATCH") +
          "</h3>";

        if (!matches) {
          html +=
            "<p><strong>Issue:</strong> Combined paragraph text does not match full text</p>";
          html +=
            "<p><strong>Full text length:</strong> " +
            fullText.length +
            " characters</p>";
          html +=
            "<p><strong>Combined paragraphs length:</strong> " +
            combinedParagraphsText.length +
            " characters</p>";
          html +=
            "<p><strong>Difference:</strong> " +
            (fullText.length - combinedParagraphsText.length) +
            " characters</p>";
        } else {
          html +=
            "<p><strong>Success:</strong> Combined paragraph text matches full text perfectly!</p>";
          html +=
            "<p><strong>Text length:</strong> " +
            fullText.length +
            " characters</p>";
          html +=
            "<p><strong>Number of paragraphs:</strong> " +
            paragraphs.length +
            "</p>";
        }
        html += "</div>";

        // Show full text
        html += '<div class="result-section">';
        html += "<h3>Full Text (getCurrentViewText)</h3>";
        html +=
          '<div class="text-content">' +
          escapeHtml(fullText.substring(0, 500)) +
          (fullText.length > 500 ? "..." : "") +
          "</div>";
        html +=
          "<p><strong>Length:</strong> " + fullText.length + " characters</p>";
        html +=
          "<p><strong>Start CFI:</strong> <code>" +
          textResult.startCfi +
          "</code></p>";
        html +=
          "<p><strong>End CFI:</strong> <code>" +
          textResult.endCfi +
          "</code></p>";
        html += "</div>";

        // Show combined paragraphs text
        html += '<div class="result-section">';
        html += "<h3>Combined Paragraphs Text</h3>";
        html +=
          '<div class="text-content">' +
          escapeHtml(combinedParagraphsText.substring(0, 500)) +
          (combinedParagraphsText.length > 500 ? "..." : "") +
          "</div>";
        html +=
          "<p><strong>Length:</strong> " +
          combinedParagraphsText.length +
          " characters</p>";
        html +=
          "<p><strong>Number of paragraphs:</strong> " +
          paragraphs.length +
          "</p>";
        html += "</div>";

        // Show individual paragraphs
        html += '<div class="result-section">';
        html += "<h3>Individual Paragraphs (" + paragraphs.length + ")</h3>";
        paragraphs.forEach(function (paragraph, index) {
          html += '<div class="paragraph-item">';
          html += "<strong>Paragraph " + (index + 1) + ":</strong> ";
          html +=
            '<div class="paragraph-text">' +
            escapeHtml(paragraph.text) +
            "</div>";
          html +=
            '<div class="paragraph-cfi"><strong>CFI:</strong> ' +
            paragraph.cfi +
            "</div>";
          html += "</div>";
        });
        html += "</div>";

        // Show detailed comparison if mismatch
        if (!matches) {
          html += '<div class="result-section mismatch">';
          html += "<h3>Detailed Comparison</h3>";
          html += "<p><strong>Full text (first 200 chars):</strong></p>";
          html +=
            '<div class="text-content">' +
            escapeHtml(fullText.substring(0, 200)) +
            "</div>";
          html +=
            "<p><strong>Combined paragraphs (first 200 chars):</strong></p>";
          html +=
            '<div class="text-content">' +
            escapeHtml(combinedParagraphsText.substring(0, 200)) +
            "</div>";

          // Find first difference
          var minLength = Math.min(
            fullText.length,
            combinedParagraphsText.length
          );
          var firstDiff = -1;
          for (var i = 0; i < minLength; i++) {
            if (fullText[i] !== combinedParagraphsText[i]) {
              firstDiff = i;
              break;
            }
          }

          if (firstDiff !== -1) {
            html +=
              "<p><strong>First difference at position " +
              firstDiff +
              ":</strong></p>";
            html +=
              '<p>Full text: "' +
              escapeHtml(
                fullText.substring(Math.max(0, firstDiff - 10), firstDiff + 10)
              ) +
              '"</p>';
            html +=
              '<p>Combined: "' +
              escapeHtml(
                combinedParagraphsText.substring(
                  Math.max(0, firstDiff - 10),
                  firstDiff + 10
                )
              ) +
              '"</p>';
          }
          html += "</div>";
        }

        resultsDiv.innerHTML = html;
      }

      function escapeHtml(text) {
        var div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Auto-run test when content is rendered
      rendition.on("rendered", function (section) {
        console.log("Section rendered:", section.href);
      });

      rendition.on("relocated", function (location) {
        console.log("Relocated to:", location);
      });
    </script>
  </body>
</html>
