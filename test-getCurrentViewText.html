<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test getCurrentViewText in Browser</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        border-left: 4px solid #28a745;
        background: #d4edda;
      }
      .error {
        border-left: 4px solid #dc3545;
        background: #f8d7da;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔍 Test getCurrentViewText in Browser</h1>
      <p>
        This test checks if getCurrentViewText() works in the browser
        environment.
      </p>

      <div id="output" class="result"></div>
    </div>

    <script src="dist/epub.min.js"></script>
    <script>
      const output = document.getElementById("output");

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}`;
        console.log(logMessage);
        output.textContent += logMessage + "\n";
        output.scrollTop = output.scrollHeight;
      }

      function runTest() {
        log("🔍 Testing getCurrentViewText in browser...");

        try {
          // Test 1: Check if ePub constructor exists
          log("🔍 Test 1: Checking ePub constructor...");
          if (typeof ePub === "undefined") {
            log("❌ ePub constructor not found");
            return;
          }
          log("✅ ePub constructor found");

          // Test 2: Check if EpubCFI is available
          log("🔍 Test 2: Checking EpubCFI availability...");
          if (typeof EpubCFI === "undefined") {
            log("❌ EpubCFI not available globally");
            log("🔍 Checking ePub.CFI...");
            if (typeof ePub.CFI === "undefined") {
              log("❌ ePub.CFI not available");
            } else {
              log("✅ ePub.CFI available");
            }
          } else {
            log("✅ EpubCFI available globally");
          }

          // Test 3: Try to create a real rendition
          log("🔍 Test 3: Creating real rendition...");

          // Create a mock book first
          const book = new ePub();

          // Create a mock rendition that mimics the real structure
          const rendition = book.renderTo("mock-container", {
            width: "600px",
            height: "400px",
            flow: "paginated",
          });

          log("✅ Rendition created");

          // Test 4: Check if getCurrentViewText method exists
          log("🔍 Test 4: Checking getCurrentViewText method...");
          if (typeof rendition.getCurrentViewText === "function") {
            log("✅ getCurrentViewText method exists");
          } else {
            log("❌ getCurrentViewText method not found");
          }

          // Test 5: Check if getCurrentViewParagraphs method exists
          log("🔍 Test 5: Checking getCurrentViewParagraphs method...");
          if (typeof rendition.getCurrentViewParagraphs === "function") {
            log("✅ getCurrentViewParagraphs method exists");
          } else {
            log("❌ getCurrentViewParagraphs method not found");
          }

          // Test 6: Try to call getCurrentViewText
          log("🔍 Test 6: Calling getCurrentViewText...");
          try {
            const textResult = rendition.getCurrentViewText();
            log(
              `📊 getCurrentViewText result: ${textResult ? "SUCCESS" : "NULL"}`
            );
            if (textResult) {
              log(
                `📊 Text length: ${
                  textResult.text ? textResult.text.length : 0
                }`
              );
            }
          } catch (e) {
            log(`❌ Error calling getCurrentViewText: ${e.message}`);
          }

          // Test 7: Try to call getCurrentViewParagraphs
          log("🔍 Test 7: Calling getCurrentViewParagraphs...");
          try {
            const paragraphsResult = rendition.getCurrentViewParagraphs();
            log(
              `📊 getCurrentViewParagraphs result: ${
                paragraphsResult ? "SUCCESS" : "NULL"
              }`
            );
            if (paragraphsResult) {
              log(`📊 Paragraph count: ${paragraphsResult.length}`);
            }
          } catch (e) {
            log(`❌ Error calling getCurrentViewParagraphs: ${e.message}`);
          }
        } catch (error) {
          log(`💥 Test failed: ${error.message}`);
          log(`Stack trace: ${error.stack}`);
        }
      }

      // Run the test when page loads
      runTest();
    </script>
  </body>
</html>
