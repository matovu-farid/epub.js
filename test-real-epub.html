<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Real EPUB Test - getCurrentViewParagraphs</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .epub-container {
        width: 600px;
        height: 400px;
        border: 1px solid #ddd;
        margin: 20px 0;
      }
      .controls {
        margin: 20px 0;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }
      .success {
        border-left: 4px solid #28a745;
        background: #d4edda;
      }
      .error {
        border-left: 4px solid #dc3545;
        background: #f8d7da;
      }
      .info {
        border-left: 4px solid #17a2b8;
        background: #d1ecf1;
      }
      .paragraph-item {
        border: 1px solid #ddd;
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        background: #f9f9f9;
      }
      .paragraph-text {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .paragraph-cfi {
        font-size: 0.9em;
        color: #666;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Real EPUB Test - getCurrentViewParagraphs()</h1>
      <p>This test loads a real EPUB file and tests the getCurrentViewParagraphs() method.</p>

      <div class="controls">
        <input type="file" id="epubFile" accept=".epub" />
        <button onclick="loadEpub()" id="loadBtn">Load EPUB</button>
        <button onclick="testGetCurrentViewText()" id="textBtn" disabled>Test getCurrentViewText</button>
        <button onclick="testGetCurrentViewParagraphs()" id="paragraphsBtn" disabled>Test getCurrentViewParagraphs</button>
        <button onclick="clearResults()">Clear Results</button>
      </div>

      <div id="epub-container" class="epub-container"></div>
      
      <div id="output" class="result"></div>
    </div>

    <script src="dist/epub.min.js"></script>
    <script>
      let book = null;
      let rendition = null;
      const output = document.getElementById("output");

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}`;
        console.log(logMessage);
        
        const outputDiv = document.getElementById("output");
        outputDiv.textContent += logMessage + "\n";
        outputDiv.className = `result ${type}`;
        outputDiv.scrollTop = outputDiv.scrollHeight;
      }

      function clearResults() {
        document.getElementById("output").textContent = "";
        document.getElementById("output").className = "result";
      }

      async function loadEpub() {
        const fileInput = document.getElementById("epubFile");
        const file = fileInput.files[0];
        
        if (!file) {
          alert("Please select an EPUB file first");
          return;
        }

        try {
          log("üîç Loading EPUB file: " + file.name, "info");
          
          // Clean up previous book if exists
          if (rendition) {
            rendition.destroy();
            rendition = null;
          }
          if (book) {
            book = null;
          }

          // Clear the container
          const container = document.getElementById("epub-container");
          container.innerHTML = "";

          // Create new book from file
          book = new ePub(file);
          
          log("üìö Book created, waiting for ready...", "info");
          
          // Wait for book to be ready
          await book.ready;
          log("‚úÖ Book is ready!", "success");

          // Create rendition
          rendition = book.renderTo("epub-container", {
            width: "100%",
            height: "100%",
            flow: "paginated"
          });

          log("üé® Rendition created, waiting for display...", "info");

          // Wait for rendition to be ready
          await rendition.display();
          log("‚úÖ Rendition displayed!", "success");

          // Enable buttons
          document.getElementById("textBtn").disabled = false;
          document.getElementById("paragraphsBtn").disabled = false;

          log("üéâ EPUB loaded successfully! You can now test the methods.", "success");

        } catch (error) {
          log(`‚ùå Error loading EPUB: ${error.message}`, "error");
          console.error("Full error:", error);
        }
      }

      function testGetCurrentViewText() {
        if (!rendition) {
          log("‚ùå No rendition available. Please load an EPUB first.", "error");
          return;
        }

        try {
          log("üîç Testing getCurrentViewText()...", "info");
          
          const startTime = Date.now();
          const result = rendition.getCurrentViewText();
          const endTime = Date.now();

          if (result) {
            log(`‚úÖ getCurrentViewText() SUCCESS!`, "success");
            log(`üìä Text length: ${result.text.length} characters`, "info");
            log(`üìä Start CFI: ${result.startCfi}`, "info");
            log(`üìä End CFI: ${result.endCfi}`, "info");
            log(`‚è±Ô∏è Execution time: ${endTime - startTime}ms`, "info");
            
            // Show first 200 characters of text
            const preview = result.text.substring(0, 200);
            log(`üìù Text preview: "${preview}${result.text.length > 200 ? '...' : ''}"`, "info");
          } else {
            log(`‚ùå getCurrentViewText() returned null`, "error");
          }

        } catch (error) {
          log(`‚ùå Error in getCurrentViewText(): ${error.message}`, "error");
          console.error("Full error:", error);
        }
      }

      function testGetCurrentViewParagraphs() {
        if (!rendition) {
          log("‚ùå No rendition available. Please load an EPUB first.", "error");
          return;
        }

        try {
          log("üîç Testing getCurrentViewParagraphs()...", "info");
          
          const startTime = Date.now();
          const result = rendition.getCurrentViewParagraphs();
          const endTime = Date.now();

          if (result && Array.isArray(result)) {
            log(`‚úÖ getCurrentViewParagraphs() SUCCESS!`, "success");
            log(`üìä Paragraph count: ${result.length}`, "info");
            log(`‚è±Ô∏è Execution time: ${endTime - startTime}ms`, "info");

            if (result.length > 0) {
              log("üìù Paragraphs:", "info");
              
              // Show each paragraph
              result.forEach((paragraph, index) => {
                const preview = paragraph.text.substring(0, 100);
                log(`üìÑ Paragraph ${index + 1}: "${preview}${paragraph.text.length > 100 ? '...' : ''}"`, "info");
                log(`üîó CFI: ${paragraph.cfi}`, "info");
                log("", "info");
              });

              // Test consistency with getCurrentViewText
              log("üîç Testing consistency with getCurrentViewText()...", "info");
              const textResult = rendition.getCurrentViewText();
              
              if (textResult) {
                const combinedText = result.map(p => p.text).join("");
                const normalizedFullText = textResult.text.replace(/\s+/g, ' ').trim();
                const normalizedCombinedText = combinedText.replace(/\s+/g, ' ').trim();
                
                if (normalizedFullText === normalizedCombinedText) {
                  log("‚úÖ Text consistency check PASSED! Paragraphs combine to match getCurrentViewText()", "success");
                } else {
                  log("‚ùå Text consistency check FAILED! Paragraphs don't match getCurrentViewText()", "error");
                  log(`üìä Full text length: ${normalizedFullText.length}`, "info");
                  log(`üìä Combined text length: ${normalizedCombinedText.length}`, "info");
                }
              }
            } else {
              log("‚ö†Ô∏è Method returned empty array", "error");
            }
          } else if (result === null) {
            log(`‚ùå getCurrentViewParagraphs() returned null`, "error");
            
            // Debug why it returned null
            log("üîç Debugging null result...", "info");
            
            if (!rendition.manager) {
              log("‚ùå No manager found", "error");
            } else {
              log("‚úÖ Manager exists", "info");
              
              const location = rendition.manager.currentLocation();
              if (!location || !location.length) {
                log("‚ùå No current location", "error");
              } else {
                log(`‚úÖ Location found: ${JSON.stringify(location[0], null, 2)}`, "info");
                
                const visibleSection = location[0];
                if (!visibleSection.mapping || !visibleSection.mapping.start || !visibleSection.mapping.end) {
                  log("‚ùå No mapping data", "error");
                } else {
                  log("‚úÖ Mapping data exists", "info");
                  
                  const view = rendition.manager.views.find({ index: visibleSection.index });
                  if (!view) {
                    log("‚ùå No view found", "error");
                  } else if (!view.contents || !view.contents.document) {
                    log("‚ùå View has no contents or document", "error");
                  } else {
                    log("‚úÖ View and contents exist", "info");
                    log("‚ùå Unknown error - method should have worked", "error");
                  }
                }
              }
            }
          } else {
            log(`‚ùå getCurrentViewParagraphs() returned unexpected result: ${typeof result}`, "error");
          }

        } catch (error) {
          log(`‚ùå Error in getCurrentViewParagraphs(): ${error.message}`, "error");
          console.error("Full error:", error);
          console.error("Stack trace:", error.stack);
        }
      }

      // Auto-focus file input
      document.getElementById("epubFile").focus();
    </script>
  </body>
</html>
