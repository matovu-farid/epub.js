<!DOCTYPE html>
<html>
  <head>
    <title>Test Highlight Element CFI</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #viewer {
        width: 800px;
        height: 600px;
        border: 1px solid #ccc;
        margin: 20px 0;
      }
      .controls {
        margin: 20px 0;
      }
      button {
        margin: 5px;
        padding: 10px 15px;
        background: #007cba;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #005a87;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        border: 1px solid #ddd;
        margin: 10px 0;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>Test Highlight Element CFI</h1>
    <p>
      This test demonstrates the new <code>highlightElement()</code> method that
      highlights an entire element based on a single CFI.
    </p>

    <div class="controls">
      <button onclick="loadBook()">Load Book</button>
      <button onclick="testHighlightElement()">Test Highlight Element</button>
      <button onclick="clearHighlights()">Clear Highlights</button>
    </div>

    <div id="viewer"></div>

    <div class="log" id="log">
      <div>Ready to test highlightElement functionality...</div>
    </div>

    <script src="../dist/epub.min.js"></script>
    <script>
      let book, rendition;

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const div = document.createElement("div");
        div.className = type;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function loadBook() {
        try {
          log("Loading book...");
          book = ePub("https://s3.amazonaws.com/moby-dick/OPS/package.opf");
          rendition = book.renderTo("viewer", {
            width: "100%",
            height: 600,
            manager: "continuous",
          });

          rendition
            .display()
            .then(() => {
              log("Book loaded successfully", "success");
              log("You can now test the highlightElement functionality");
            })
            .catch((err) => {
              log(`Error loading book: ${err.message}`, "error");
            });
        } catch (err) {
          log(`Error initializing: ${err.message}`, "error");
        }
      }

      async function testHighlightElement() {
        if (!rendition) {
          log("Please load a book first", "error");
          return;
        }

        try {
          log("Testing highlightElement method...");

          // Get current location to find a CFI
          const location = rendition.currentLocation();
          if (!location) {
            log("No current location available", "error");
            return;
          }

          log(`Current location CFI: ${location.start.cfi}`);

          // Test highlighting the element at the current location
          await rendition.highlightElement(
            location.start.cfi,
            { test: true, timestamp: new Date().toISOString() },
            (e) => {
              log("Highlight clicked!", "success");
              console.log("Click event:", e);
            },
            "epubjs-hl-test",
            { fill: "rgba(255, 0, 0, 0.3)" }
          );

          log("Element highlighted successfully!", "success");
        } catch (err) {
          log(`Error highlighting element: ${err.message}`, "error");
          console.error(err);
        }
      }

      function clearHighlights() {
        if (!rendition) {
          log("Please load a book first", "error");
          return;
        }

        try {
          rendition.annotations.clear();
          log("Highlights cleared", "success");
        } catch (err) {
          log(`Error clearing highlights: ${err.message}`, "error");
        }
      }

      // Add some event listeners for debugging
      if (typeof rendition !== "undefined") {
        rendition.on("relocated", function (location) {
          log(`Relocated to: ${location.start.cfi}`);
        });

        rendition.on("selected", function (cfiRange) {
          log(`Text selected: ${cfiRange}`);
        });
      }
    </script>
  </body>
</html>
